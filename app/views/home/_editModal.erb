
<!-- EditModal -->
<div class="modal fade" id="editModalCenter" tabindex="-1" role="dialog"
     aria-labelledby="editModalCenterTitle" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document" style="max-width: 900px;">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editModalCenterTitle">编辑</h5>
        <button type="button" class="close" @click="closeCatalogsModal">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div id="modal-body" class="modal-body">

        <draggable v-model="catalogs" :options="{group:'catalogs'}" @start="drag=true" @end="drag=false">
          <div v-for="catalog in catalogs" :key="catalog.id">
            <div class="calalog clearfix">
              <div class="calalog-title" >
                <span class="drag-handle">☰</span>
                <span class="name-text">{{catalog.title}}</span>
                <button type="button" class="btn btn-link float-right del" @click="deleteCatalog(catalog)">
                  <span>&times;</span>
                </button>
              </div>
              <draggable v-model="catalog.links" :options="{group:catalog.id}" @start="drag=true" @end="drag=false" class="row calalog-items">
                <div v-for="link in catalog.links" :key="link.id" class="calalog-item text-dark"
                     style="border:1px dashed rgba(125,125,125,0.5);">
                  <img :src="link.icon" height="16" width="16" class="nav-icon">
                  <div class="nav-text">
                    <span class="nav-text-content">{{link.title}}</span>
                  </div>
                  <button type="button" class="btn btn-link float-right del" @click="deleteLink(catalog,link)">
                    <span>&times;</span>
                  </button>
                </div>
              </draggable>
            </div>
          </div>
        </draggable>

      </div>
      <div class="modal fade" id="newCatalogModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">新建分类</h5>
            </div>
            <div class="modal-body">
              <input type="text" class="form-control" placeholder="新分类" v-model="new_catalog_title">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="$('#newCatalogModal').modal('hide')">Close</button>
              <button type="button" class="btn btn-primary" @click="saveCatalog">Save</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal fade" id="newLinkModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLongTitle">新建链接</h5>
            </div>
            <div class="modal-body">
              <img :src="new_link_icon" height="16" width="16" class="nav-icon">
              <select class="form-control" v-model="new_link_catalog_id">
                <option v-for="catalog in catalogs" v-bind:value="catalog.id">
                  {{ catalog.title }}
                </option>
              </select>
              <input type="text" class="form-control" placeholder="标题" v-model="new_link_title">
              <input type="text" class="form-control" placeholder="地址" v-model="new_link_url">
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" onclick="$('#newLinkModal').modal('hide')">Close</button>
              <button type="button" class="btn btn-primary" @click="saveLink">Save</button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <div style="width: 100%;">
          <button type="button" class="btn btn-link" data-toggle="modal" data-target="#newCatalogModal">
            <span class="text-dark" style="font-size: 14px;">+分类</span>
          </button>
          <button type="button" class="btn btn-link" data-toggle="modal" data-target="#newLinkModal">
            <span class="text-dark" style="font-size: 14px;">+链接</span>
          </button>
        </div>
        <!--<button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>-->
        <button type="button" class="btn btn-primary" @click="uploadCatalogs">Save changes</button>
      </div>
    </div>
  </div>
</div>

<script>
    var app = new Vue({
        el: '#editModalCenter',
        data: {
            catalogs: [],
            catalogs_str: '<%== @catalogs %>',
            new_catalog_title: '',
            new_link_catalog_id: '',
            new_link_title: '',
            new_link_url: '',
            new_link_icon: ''
        },
        created: function () {
            this.catalogs = JSON.parse(this.catalogs_str)
        },
        watch: {
            new_link_url: function (newUrl, oldUrl) {
                var url = $.url(newUrl);
                this.new_link_icon = url.attr('base')+'/favicon.ico'
            }
        },
        methods: {
            uploadCatalogs: function () {
                console.log(this.catalogs)
                console.log(JSON.stringify(this.catalogs))
                $('#editModalCenter').modal('hide');
                //location.reload();
            },
            closeCatalogsModal: function () {
                $('#editModalCenter').modal('hide');
                this.catalogs = JSON.parse(this.catalogs_str)
                //location.reload();
            },
            deleteCatalog: function (catalog) {
                this.removeFromList(this.catalogs, catalog)
            },
            deleteLink: function (catalog, link) {
                this.removeFromList(catalog.links, link)
            },
            saveCatalog: function () {
                this.catalogs.push(JSON.parse('{"id":'+this.getRandomTmpId()+',"title":"'+this.new_catalog_title+'","links":[]}'));
                $('#newCatalogModal').modal('hide');
                this.new_catalog_title = '';
            },
            saveLink: function () {
                for( var index = 0; index < this.catalogs.length; index ++){
                    if(this.catalogs[index].id == this.new_link_catalog_id){
                        this.catalogs[index].links.push(JSON.parse('{"id":'+this.getRandomTmpId()+',"title":"'+this.new_link_title+'","catalog_id":2,"url":"'+this.new_link_url+'","icon":"'+this.new_link_icon+'"}'));
                    }
                }
                this.new_link_catalog_id= '';
                this.new_link_title= '';
                this.new_link_url= '';
                this.new_link_icon= '';
                $('#newLinkModal').modal('hide');
            },
            removeFromList: function(arr, val) {
                var index = arr.indexOf(val);
                if (index > -1) {
                    arr.splice(index, 1);
                }
            },
            getRandomTmpId: function () {
                return Math.floor(Math.random()*(-10000)-1);
            }
        }
    })

    $('#editModalCenter').modal('show');
</script>